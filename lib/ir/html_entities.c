/*                               -*- Mode: C -*- 
 * html_entities.c -- 
 * ITIID           : $ITI$ $Header $__Header$
 * Author          : Ulrich Pfeifer
 * Created On      : Mon Jan 27 22:06:08 1997
 * Last Modified By: Ulrich Pfeifer
 * Last Modified On: Mon Jan 27 22:18:02 1997
 * Language        : C
 * Update Count    : 2
 * Status          : Unknown, Use with caution!
 * 
 * (C) Copyright 1997, Universität Dortmund, all rights reserved.
 * 
 * $$
 * $Log: html_entities.c,v $
 * Revision 2.1  1997/02/08 10:59:30  pfeifer
 *  added cons files
 *
 */

#include "html_entities.h"

static char htab[947] =
{
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ',
  '\354',			/* igrave => ì */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ',
  '\333',			/* Ucirc => Û */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\363',			/* oacute => ó */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\267',			/* middot => · */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\244',			/* curren => ¤ */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\322',			/* Ograve => Ò */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\332',			/* Uacute => Ú */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\362',			/* ograve => ò */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ',
  '\277',			/* iquest => ¿ */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ', ' ',
  '\321',			/* Ntilde => Ñ */
  ' ', ' ', ' ', ' ', ' ', ' ',
  '\342',			/* acirc => â */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\372',			/* uacute => ú */
  ' ', ' ', ' ',
  '\346',			/* aelig => æ */
  ' ', ' ', ' ', ' ',
  '\270',			/* cedil => ¸ */
  ' ', ' ',
  '\330',			/* Oslash => Ø */
  ' ', ' ',
  '\325',			/* Otilde => Õ */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ',
  '\264',			/* acute => ´ */
  ' ', ' ', ' ', ' ', ' ', ' ',
  '\335',			/* Yacute => Ý */
  ' ', ' ',
  '\352',			/* ecirc => ê */
  ' ', ' ', ' ', ' ', ' ',
  '\361',			/* ntilde => ñ */
  ' ',
  '\76',			/* gt => > */
  '\331',			/* Ugrave => Ù */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\74',			/* lt => < */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ',
  '\370',			/* oslash => ø */
  ' ', ' ',
  '\365',			/* otilde => õ */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\345',			/* aring => å */
  '\304',			/* Auml => Ä */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\356',			/* icirc => î */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\375',			/* yacute => ý */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\313',			/* Euml => Ë */
  '\371',			/* ugrave => ù */
  ' ', ' ', ' ', ' ', ' ', ' ',
  '\261',			/* plusmn => ± */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\317',			/* Iuml => Ï */
  ' ',
  '\241',			/* iexcl => ¡ */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\306',			/* AElig => Æ */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ',
  '\253',			/* laquo => « */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\364',			/* ocirc => ô */
  ' ', ' ', ' ',
  '\265',			/* micro => µ */
  '\326',			/* Ouml => Ö */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\301',			/* Aacute => Á */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\320',			/* ETH => Ð */
  ' ', ' ',
  '\307',			/* Ccedil => Ç */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\334',			/* Uuml => Ü */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ',
  '\273',			/* raquo => » */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\341',			/* aacute => á */
  ' ', ' ',
  '\373',			/* ucirc => û */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\336',			/* THORN => Þ */
  '\242',			/* cent => ¢ */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\347',			/* ccedil => ç */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\327',			/* times => × */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\311',			/* Eacute => É */
  ' ', ' ', ' ', ' ',
  '\344',			/* auml => ä */
  ' ',
  '\257',			/* macr => ¯ */
  ' ',
  '\243',			/* pound => £ */
  ' ',
  '\376',			/* thorn => þ */
  '\300',			/* Agrave => À */
  ' ', ' ', ' ',
  '\251',			/* copy => © */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\353',			/* euml => ë */
  ' ', ' ', ' ', ' ', ' ', ' ',
  '\266',			/* para => ¶ */
  ' ', ' ', ' ', ' ',
  '\240',			/* nbsp =>   */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ', ' ',
  '\302',			/* Acirc => Â */
  ' ',
  '\357',			/* iuml => ï */
  ' ', ' ', ' ',
  '\247',			/* sect => § */
  ' ', ' ', ' ',
  '\351',			/* eacute => é */
  ' ', ' ', ' ',
  '\252',			/* ordf => ª */
  ' ', ' ', ' ', ' ', ' ',
  '\260',			/* deg => ° */
  '\272',			/* ordm => º */
  '\340',			/* agrave => à */
  ' ', ' ', ' ', ' ', ' ', ' ',
  '\271',			/* sup1 => ¹ */
  '\262',			/* sup2 => ² */
  '\263',			/* sup3 => ³ */
  ' ',
  '\46',			/* amp => & */
  ' ',
  '\337',			/* szlig => ß */
  ' ', ' ', ' ', ' ', ' ',
  '\275',			/* frac12 => ½ */
  ' ',
  '\274',			/* frac14 => ¼ */
  ' ', ' ', ' ',
  '\276',			/* frac34 => ¾ */
  ' ', ' ',
  '\366',			/* ouml => ö */
  ' ', ' ', ' ', ' ',
  '\360',			/* eth => ð */
  ' ', ' ', ' ', ' ', ' ',
  '\315',			/* Iacute => Í */
  ' ', ' ',
  '\312',			/* Ecirc => Ê */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\310',			/* Egrave => È */
  ' ', ' ',
  '\256',			/* reg => ® */
  ' ',
  '\42',			/* quot => " */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\303',			/* Atilde => Ã */
  ' ', ' ', ' ',
  '\254',			/* not => ¬ */
  ' ', ' ', ' ', ' ',
  '\374',			/* uuml => ü */
  ' ', ' ', ' ', ' ', ' ',
  '\255',			/* shy => ­ */
  ' ', ' ', ' ', ' ',
  '\250',			/* uml => ¨ */
  ' ',
  '\245',			/* yen => ¥ */
  ' ', ' ', ' ', ' ',
  '\305',			/* Aring => Å */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\316',			/* Icirc => Î */
  ' ',
  '\377',			/* yuml => ÿ */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\355',			/* iacute => í */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\350',			/* egrave => è */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ',
  '\343',			/* atilde => ã */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\367',			/* divide => ÷ */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\314',			/* Igrave => Ì */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\324',			/* Ocirc => Ô */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
  '\246',			/* brvbar => ¦ */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', 
  ' ', ' ', ' ',
  '\323',			/* Oacute => Ó */
  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
};

static unsigned int 
hash (s)
     unsigned char *s;
{
  unsigned int result = 0;

  while (*s) {
    result = (result << 1) % 947;
    result += *s;
    s++;
  }
  return (result % 947);
}

static char *
end_entity (s)
     char *s;
{
  char *end = s + 7;

  while (++s < end) {
    if (!isalnum(*s)) return(s);
  }
  return (NULL);
}

void
decode_entities (s)
     char *s;
{
  char *space = s - 1;
  char *e;
  int pl;

  while (*s) {
    switch (*s) {
    case ' ':
      space = s;
      break;
    case '&':
      if (s[1] == '#') {
	unsigned int code = 0;

	e = s + 2;
	while (isdigit (*e)) {
	  code = code * 10 + *e;
	  e++;
	}
	if (*e != ';')		/* the single correct value */
	  e--;			/* '\0' terminated :-( */

	*e = code;
      } else {
	if ((e = end_entity (s))) {
	  unsigned int code;
	  char se = *e;

	  *e = '\0';
	  code = hash (s + 1);
	  *e = se;
	  if (*e != ';')	/* the single correct value */
	    e--;		/* '\0' terminated :-( */

	  *e = htab[code];
	}
      }
      /* xx fgg&auml;bar */
      /* x ^   s    e    */
      if (e) {
        pl = s - space - 1;
        bcopy (space + 1, e - pl, pl);
        memset (space + 1, ' ', e - pl - (space + 1));
      }
    }
    s++;
  }
}

#ifdef TEST_ENTITIES
main (argc, argv)
     int argc;
     char *argv[0];
{
  while (--argc) {
    char *s;

    argv++;
    fprintf (stderr, "=> [%s]\n", argv[0]);
    decode_entities(argv[0]);
    fprintf (stderr, "<= [%s]\n", argv[0]);
  }
}
#endif
